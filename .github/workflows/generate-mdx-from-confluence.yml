name: Generate MDX from Confluence
run-name: "Generate MDX from Confluence - ${{ inputs.arguments }}"

on:
  workflow_dispatch:
    inputs:
      arguments:
        description: 'Arguments for pages_of_confluence.py'
        required: false
        type: choice
        options:
          - '--recent'
          - '--recent --attachments'
          - '--remote'
          - '--remote --attachments'
          - '--local'
        default: '--recent --attachments'

jobs:
  generate-mdx:
    runs-on: ubuntu-latest
    permissions:
      contents: write # to create a branch and push changes
      pull-requests: write # to create a PR
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 히스토리 가져오기 (git status를 위해 필요)

      - name: Workflow Arguments
        run: |
          echo "Arguments: ${{ inputs.arguments }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull latest Docker image
        working-directory: ./confluence-mdx
        run: |
          set -o xtrace
          docker --version
          docker compose version
          touch .env # Create an empty .env to prevent missing .env error.
          # 플랫폼을 명시적으로 지정하여 아키텍처 불일치 오류 방지
          DOCKER_DEFAULT_PLATFORM=linux/amd64 docker compose --progress=quiet pull confluence-mdx

      - name: Docker image status
        working-directory: ./confluence-mdx
        run: |
          STATUS=$(docker compose run --rm confluence-mdx status --top 5)
          echo "$STATUS"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "$STATUS" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Generate MDX files
        working-directory: ./confluence-mdx
        env:
          ATLASSIAN_TOKEN: ${{ secrets.ATLASSIAN_TOKEN }}
        run: |
          set -o xtrace
          docker compose run --rm -e ATLASSIAN_TOKEN confluence-mdx full ${{ inputs.arguments }}

      - name: Check for changes
        run: |
          echo "=== Git Status ==="
          git status

      - name: Create Pull Request for changes
        env:
          GH_TOKEN: ${{ github.token }}
        run: .github/scripts/create-mdx-pr.sh "${{ github.event_name }}" "${{ github.actor }}"

