---
title: 'Audit Log Export'
---

import { Callout } from 'nextra/components'

# Audit Log Export

### Overview

QueryPieで生成された各種監査ログを抽出し、csvファイルでダウンロードできる機能です。長期間にわたるログなど大容量ファイルの場合でも安定した抽出およびダウンロードが可能です。一度生成されたログ抽出ファイルは30日間ダウンロードが可能です。抽出サポートログはQuery Audit、Workflow SQL Requestなど21種類です。

<Callout type="important">
Audit Log Export機能追加に伴い、各ログ画面で提供されていた'Excel File Download'ボタンはQueryPie v9.15.0からサポートが中断されました。
</Callout>

<Callout type="important">
**抽出サポートログ種類（QueryPie v11.0.0基準）**
1. Query Audit [CSV]
2. Workflow SQL Request [CSV]
3. Workflow SQL Request for Query Details [CSV]
4. Workflow SQL Export Request [CSV]
5. Workflow DB Access Request [CSV]
6. Workflow Server Access Request [JSON]
7. User Access History [CSV]
8. Admin Role History [CSV]
9. DB Access History [CSV]
10. DB Account Lock History [CSV]
11. DB Access Control Logs [CSV]
12. Server Access History [JSON]
13. Command Audit [JSON]
14. Session Logs [JSON]
15. Server Access Control Logs [JSON]
16. Server Role History [JSON]
17. Activity Logs [JSON]
18. DML Snapshot [JSON]
19. Server Account Lock History [JSON]
20. Request Audit [JSON]
21. Kubernetes Role History [JSON]
22. Alert Logs [JSON] **[10.3.0]**
23. Restricted Data Access Logs [JSON] **[10.3.0]**
24. Masked Data Access Logs [JSON] **[10.3.0]**
25. Sensitive Data Access Logs [JSON] **[10.3.0]**
26. Web Access History [CSV] **[11.0.0]**
27. Web Event Audit [CSV] **[11.0.0]**
28. Web App Role History [CSV] **[11.0.0]**
29. JIT Access Control Logs [CSV] **[11.0.0]**
30. Workflow Unmasking Request Logs [JSON] **[11.0.0]**
31. Workflow Restricted Data Access Request [JSON] **[11.0.0]**
32. Workflow DB Policy Exception Request Logs [JSON] **[11.0.0]**
</Callout>


### Audit Log Export一覧の照会

<figure data-layout="center" data-align="center">
![Administrator &gt; Audit &gt; General &gt; Audit Log Export](/administrator-manual/audit/reports/audit-log-export/image-20240714-063656.png)
<figcaption>
Administrator &gt; Audit &gt; General &gt; Audit Log Export
</figcaption>
</figure>

1. Administrator &gt; Audit &gt; General &gt; Audit Log Exportメニューに移動します。
2. 現在まで生成されたAudit Log Exportタスク一覧を確認できます。
3. Statusではタスクの進行状態を確認できます。
   * **Processing**: 監査ログ抽出が進行中です。
   * **Completed**: 監査ログ抽出が完了し、ファイルダウンロードが可能です。（抽出完了後30日が経過した場合、ファイルが期限切れでダウンロードが不可能です。）
   * **Failed**: 監査ログ抽出が失敗しました。QueryPie Customer Supportを通じてお問い合わせください。

### ログ抽出作業の作成

監査ログ抽出およびダウンロードは大きく以下のような段階で進行されます。（1）関連メニュー進入 → （2）ログ抽出作業作成 → （3）ログ抽出完了まで待機 → （4）抽出完了時ファイルダウンロード

監査ログ抽出を開始するには'Audit &gt; General &gt; Audit Log Export'メニューアクセス後、右上の`Create Task`ボタンをクリックする必要があります。該当ボタンクリック時、以下のような画面が現れます。

<figure data-layout="center" data-align="center">
![Administrator &gt; Audit &gt; General &gt; Audit Log Export &gt; Create New Task](/administrator-manual/audit/reports/audit-log-export/screenshot-20250116-131805.png)
<figcaption>
Administrator &gt; Audit &gt; General &gt; Audit Log Export &gt; Create New Task
</figcaption>
</figure>

1. **Task Name**: ログ抽出作業の名前を入力します。
2. **Log Type**: 抽出対象ログの種類を選択します。
   1. Query Auditなど抽出したいログタイプを選択します。
   2. ログ種類選択後、See Log Template and Descriptionをクリックすると各ログのkeyなど詳細情報を照会できます。
3. **Download File Format**: ログ出力ファイル形式を指定します。（9.17.0基準、各ログごとにダウンロード可能な形式が単一に制限されます。上部の**'抽出サポートログ種類'**を参照してください。）
4. **For Text Exceeding 32,000 Characters**: CSVファイルの場合、32,000文字を超過する文字を切り取るかどうかを選択できます。
   1. Trim Overflowing Text - 32,000文字を超過する文字を切り取ります。Excelでファイルを直接開く必要がある場合にセル当たり最大文字数超過で表が壊れる現象を防止します。
   2. No Action - 32,000文字を超過する文字をそのまま含めます。
5. **From**: 抽出開始日付を指定します。
6. **To**: 抽出対象最後の日付を指定します。11.2.0から当日日付を選択できるように改善されました。
7. **Filter Expression**: フィルター表現式を指定します。
   1. 条件入力方法および例は下部の'**フィルター表現式**'を参照してください。
8. **Generate Preview**: プレビューを生成します。
   1. プレビューは必須段階です。
   2. プレビュー結果を確認してから次の段階である'Create'が可能です。
9. `Create`ボタン: ログ抽出作業を生成します。

<Callout type="info">
**注意事項**
当日日付を選択してログを抽出する場合、リアルタイムでデータが積まれるため、Preview時点の結果と実際のCreateを通じて生成されたファイルの内容が異なる場合があります。
</Callout>

<Callout type="important">
**フィルター表現式**

(1) フィルター表現式を使用するために'See Log Template and Description'を通じてログ別keyとそれぞれのtypeおよび含むvalueを参照してください。<br/>

(2) 使用可能なフィルター表現式はデータの種類によって以下のように分かれます。

- Number Type

サポートする表現式: `&gt;`, `&lt;`, `&lt;=`, `&gt;=`, `==`, `!=`<br/>例: `x &gt; `10``, `x == `10``

- String Type

サポートする表現式: `== (equals)`, `!= (not equals)`, `contains`<br/>例: `x == 'abc'`, `x != 'abc'`, `contains(x, 'ab')`

- Boolean Type

サポートする表現式: `== (equals)`, `!= (not equals)`, `&& (and)`, `|| (or)`<br/>例: `x == `true``,`x && y`, `(x &gt; `0`) && (y == `0`)`

- Array Type

例: `x[? @ == 'value']`, `list[? @ &gt; `10`]`


(3) 複数の条件を一緒に使用するために以下の文字を活用できます。

- AND条件: `&&`演算子を活用します。

- OR条件: `||`演算子を活用します。

- 複合条件: 一緒に処理すべき条件は括弧(`( )`)で囲んで活用します。


(4) 例

- Query Audit中クエリ実行ログのみ抽出したい場合に必要な表現式: `actionType == 'SQL_EXECUTION'`

- Query Audit中ウェブエディターで実行したクエリ実行ログのみ抽出したい場合に必要な表現式: `actionType == 'SQL_EXECUTION' && executedFrom == 'WEB_EDITOR'`

- DB Access History中特定データベース2種類に対してのみ抽出したい場合に必要な表現式: `connectionName == 'database1' || connectionName == 'database2'`

- DB Access History中特定データベース2種類でありながらReplication TypeがSINGLEの場合に対してのみ抽出したい場合に必要な表現式: `(connectionName == 'database1' || connectionName == 'database2') && replicationType == 'SINGLE'`
</Callout>


<Callout type="important">
**Query AuditのエクスポートファイルのPrivilege Type明示基準**

エクスポートファイルの'Privilege Type'カラムには実行時点にどの権限が必要だったかが記録されます。以下のように動作します。

1. 基本権限で実行されるコマンド（SET、SHOWなど）は該当カラムの値が空白です。
2. INSERTなど権限に従って実行されたログにはSQL Typeが明示されます。
3. Redisの場合はコマンド名が明示されます。
</Callout>


### 抽出作業完了時ファイルダウンロード

別途のフィルタリング条件がない短期間照会の場合にはログ抽出が数分以内に完了します。長期間にわたるログやフィルタリング条件の複雑度が高い場合などではログ抽出まで多少時間がかかる場合があります。

抽出作業が完了した後には2つの方法でログファイルをダウンロードできます。

1. 一覧ページでダウンロード: 一覧ページでDownloadボタンをクリックします。
2. 詳細ページでダウンロード: 一覧ページでタスクをクリックして詳細ページに進入、右上Downloadボタンをクリックします。

<Callout type="important">
**ダウンロードファイルにパスワード含める**

ダウンロード対象ファイルは'*.csvまたは*.jsonファイルを圧縮した*.zipファイル'です。

該当圧縮ファイルに対するパスワードを指定するには'General Setting &gt; Security'メニューで`Export a file with Encryption`オプションを'Required'に指定する必要があります。
</Callout>


### ログ抽出ファイル保管期間政策案内

抽出が完了したログファイルは作業生成日から30日間保管され、該当期間以内には回数制限なしにダウンロードが可能です。しかし、30日が経過するとファイルが期限切れになります。期限切れのログファイルが必要になった場合、ログ抽出タスクを再生成してください。
