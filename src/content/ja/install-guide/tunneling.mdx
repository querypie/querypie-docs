# 🔗 ローカルデータベースとの接続

このガイドは、ローカルで実行中のデータベースをQueryPie AIサービスに接続する方法を案内します。適切なDSN（Data Source Name）文字列生成と、リモートアクセスのためのセキュリティトンネル設定方法を扱います。


## 概要

ローカル開発環境で作業する際、ローカルマシンで実行中のデータベースをQueryPie AI Hubに接続する必要がある場合があります。

```mermaid
---
config:
  look: handDrawn
  theme: neutral
---

graph TB
    subgraph YourComputer ["💻 あなたのローカルPC"]
        LocalDB[("ローカルデータベース<br/>(PostgreSQL, MySQL, Redis, など)")]
        TunnelService["トンネルサービス<br/>(ngrok など)"]
        LLMApp["LLMアプリ<br/>(Cursor, Windsurf, など)"]
        
        LocalDB --> TunnelService
    end
    
    subgraph Internet ["🌐 インターネット"]
        QueryPieAIHub["QueryPie AI Hub"]
    end
    
    TunnelService -.->|"セキュアトンネル"| QueryPieAIHub
    LLMApp -.->|"Model Context Protocol"| QueryPieAIHub
    
    %% Styles
    style YourComputer fill:#f5f5f5,stroke:#333,stroke-width:2px
    style Internet fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style LocalDB fill:#e1f5fe,stroke:#1976d2
    style TunnelService fill:#fff3e0,stroke:#f57c00
    style LLMApp fill:#f3e5f5,stroke:#7b1fa2
    style QueryPieAIHub fill:#e8f5e8,stroke:#388e3c
```
ローカルデータベースに接続するには、以下の項目を準備してください。

1. ローカルデータベースインスタンス（例：PostgreSQL、MySQL、Redisなど）
2. ローカルデータベースをインターネット経由でアクセス可能にするトンネルサービス
3. 適切なDSN文字列構成


## トンネルサービスオプション
トンネルサービスとしては、ngrok、Cloudflare Tunnelなどを使用できます。

### ngrok

追加機能を提供する人気のトンネリングソリューションです。

```bash filename="ngrokインストール" copy
brew install ngrok
```

```bash filename="PostgreSQLトンネル作成" copy
ngrok tcp 5432
```

DSN文字列は以下のように入力できます。

```bash filename="PostgreSQL DSN例" copy
postgresql://username:password@X.tcp.ngrok.io:XXXXX/dbname
```

### Cloudflare Tunnel

Cloudflare Tunnelは無料で安定したトンネリングサービスです。

```bash filename="Cloudflare Tunnelインストール" copy
brew install cloudflared
```

```bash filename="トンネル作成と実行" copy
cloudflared tunnel --url tcp://localhost:5432
```

## 完全な設定例

PostgreSQLとngrokを使用した完全な設定過程を見てみましょう：

### 1. ローカルPostgreSQLサーバー開始
PostgreSQLがデフォルトポート5432で実行されているか確認します。
```bash filename="1段階：PostgreSQL開始" copy
brew services start postgresql
```

### 2. ngrokトンネル作成
名前付きトンネルを作成します。
```bash filename="2段階：ngrokトンネル作成" copy
ngrok tcp 5432
```

トンネルが作成されると、以下のような出力を見ることができます。

```bash filename="ngrok出力例" copy
Session Status                online
Account                       your-account (Plan: Free)
Version                       3.x.x
Region                        United States (us)
Latency                       -
Web Interface                 http://127.0.0.1:4040
Forwarding                    tcp://0.tcp.ngrok.io:12345 -> localhost:5432
```

### 3. QueryPie AIでDSN文字列構成

上記のngrok出力で提供された情報を使用してDSN文字列を生成します：

```bash filename="3段階：DSN文字列構成" copy
postgresql://username:password@0.tcp.ngrok.io:12345/dbname
```

このDSN文字列を使用してQueryPie AI Hubでデータベースを追加できます。

## セキュリティ考慮事項

ローカルデータベースをインターネットに公開する際は、常に以下の事項を遵守してください。

- 🔒 強力なパスワードとユーザー名を使用してください。
- 🌐 既知のIP範囲からのみ接続を許可してください。
- 🔐 SSL暗号化接続を使用してください。QueryPie AI HubでもSSL接続をサポートしています。
- 📊 データベース接続ログを維持し、モニタリングしてください。
- ⏱️ 開発時には一時的なトンネルを使用した後、すぐに終了してください。

## トラブルシューティング

トンネリング接続を使用する際に発生する一般的な問題と解決方法を案内します。

### 1. 接続タイムアウト
- トンネルが実行中か確認してください。
- ローカルデータベースが外部接続を許可するか確認してください。
- ファイアウォールルールが接続を許可するか確認してください。

### 2. 認証エラー
- データベース認証情報を確認してください。
- データベースユーザーが適切な権限を持っているか確認してください。
- DSN文字列形式が正しいか確認してください。

### 3. SSL/TLS問題
- 必要な場合、SSL証明書を構成してください。
- セキュリティ接続のため、DSN文字列に`sslmode=require`を追加してください。

### 4. ポート競合
- 他のサービスが同じポートを使用しているか確認してください。
- 必要な場合、他のポートに変更してください。

## Roadmap: Tunneling
今後、ローカルプロキシにトンネリング機能が追加される予定です。（2025年第3四半期予定）<br/>
ローカルプロキシに搭載されるトンネリング機能を通じて、QueryPie AI Hubとユーザーのネットワークが接続できるようになります。<br/>
これにより、以下のようなことができるようになります。
- ユーザーネットワークで実行中のMCP Serverを接続して使用
- QueryPieを使用中であれば、QueryPieを通じたより安全なDB、Server、Kubernetesアクセス
- QueryPieを使用していなくても、DB、Server、Kubernetesアクセスサポート

![Tunneling CLI Client](@/app/img/tunneling-drawio-1.png)


## 追加リソース

- [ngrok公式ドキュメント](https://ngrok.com/docs)
- [Cloudflare Tunnelドキュメント](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/) 