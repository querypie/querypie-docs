import { Callout } from 'nextra/components'

## Overview
Slack App을 QueryPie에 연동하고, QueryPie로부터 Direct Message 알림을 수신할 수 있습니다.

<Callout type="info">
본 문서는  **10.2.6 또는 그 이상의 버전** 에 적용됩니다.
10.2.5 또는 그 이하 버전의 Slack 연동 방법은 [10.1.0 버전 매뉴얼 문서](https://docs.querypie.com/ko/querypie-manual/10.1.0/workflow-configurations)를 참고해주세요.
</Callout>

### 구성 시 사전에 필요한 권한
* Slack Workspace 관리자 권한 계정 (Slack Workspace에 App을 설치하기 위해 필요)
* QueryPie Owner 및 Approval Admin 권한 계정

## Slack API 에서 DM App 생성 (via Manifest Files)
App Manifest를 이용하여 QueryPie DM 연동 전용 Slack App을 생성합니다.



1. [https://api.slack.com/apps](https://api.slack.com/apps) 으로 이동하여 `Create an App` 을 클릭합니다.<br/>
2. Create an app 모달에서, App 생성 방식을 선택합니다. `From a manifest` 를 클릭합니다.<br/>
3. Pick a workspace 모달에서 QueryPie와 연동할 Slack Workspace를 선택한 뒤 다음 단계로 진행합니다.<br/>
4. Create app from manifest 모달에서 JSON 형식의 App Manifest를 입력합니다. <br/>미리 채워져 있는 내용들을 삭제하고 아래의 App Manifest를 붙여넣은 뒤 다음 단계로 진행합니다.<br/>:light_bulb_on: `{{..}}` 안의 값은 원하는 값으로 변경해 주세요.
5. 설정 내용을 검토하고 `Create` 버튼을 클릭하여 App 생성을 완료합니다.<br/>

## Slack Workspace에 Slack App 설치
1. Settings &gt; Install App에서 `Install to Workspace` 버튼을 클릭하여 생성된 앱을 Slack Workspace에 설치합니다. 
2. 권한 요청 페이지에서, `허용`을 클릭합니다.
3. 설정한 Slack Workspace에서 Slack DM 전용 App이 생성된 것을 확인할 수 있습니다.

## Bot User OAuth Token 획득
Features &gt; OAuth & Permissions 메뉴 내 OAuth Tokens for Your Workspace 섹션에서,  **Bot User OAuth Token**  을 복사하여 기록해 둡니다.

<p align="center">
<div>[image-20240418-022640.png]()</div>
</p>



## App-Level Token 생성
<Callout type="info">
App manifest로 Slack app을 생성할 때 Socket Mode와 관련 권한들을 활성화할 수는 있지만, App Level Token(xapp-)은 자동으로 생성되지 않습니다.
* App Level Token은 보안 자격 증명(security credential)이기 때문에 manifest로 자동 생성/노출되면 보안상 위험
* App manifest는 앱의 구성(configuration)만 정의하고, 실제 인증 토큰들은 별도로 생성/관리됨
</Callout>

다음 단계를 수행하여 App-Level Token을 수동으로 생성합니다.

1. 앱 설정 페이지의 Settings &gt; Basic Information 메뉴의 App-Level Tokens 섹션으로 이동하고, `Generate Token and Scope` 버튼을 클릭합니다.<br/>
2. Generate an app-level token 모달에서, Add Scope 버튼을 클릭한 뒤 `connections:write` 를 추가합니다.<br/>
3. 생성된 App-Level Token 모달에서, 앱 토큰을 복사하여 따로 기록해 둡니다. App-Level Token은 `xapp-` 으로 시작합니다.

## QueryPie에서 Slack DM 설정하기
1. Admin &gt; General &gt; System &gt; Integrations &gt; Slack 메뉴로 진입한 뒤, `Configure` 버튼을 클릭하여 설정 모달을 엽니다.<br/>
2. 설정 모달에 아까 기록해둔 App Token과 Bot User OAuth Token을 입력합니다.
3. 추가 설정 값은 다음과 같습니다. DM으로 Workflow 알림을 받고 메시지 안에서 승인/거절을 수행하려면 모든 설정 토글을 활성화 합니다.
    *  **Send Workflow Notification via Slack DM**  : 워크플로우 요청에 대한 Slack DM 전송 활성화
    *  **Allow Users to approve or reject on Slack DM**  : Slack DM 내에서 승인 또는 거절 기능 활성화<br/>
4. `Save` 버튼을 누르고 설정을 완료합니다.

## Slack DM 설정 관리하기
1. Slack Configuration을 등록한 뒤, 현재 설정 상태를 화면에서 확인할 수 있습니다.<br/>
2. `Edit` 버튼을 클릭하여 입력한 설정을 변경할 수 있습니다.<br/>



## Workflow 요청 시 Slack DM 테스트
DB Access Request를 예시로, Slack DM 기능이 정상적으로 작동하는지 테스트를 수행합니다.

1. QueryPie User &gt; Workflow 페이지에서 Submit Request 버튼을 클릭한 뒤, DB Access Request를 선택하여 요청 작성 화면으로 진입합니다. 요청 작성 화면에서 필요한 정보를 입력하고, 요청을 상신합니다.
2. 승인자는 앞에서 추가한 Slack App과의 DM으로 승인해야 할 요청 알림을 수신할 수 있습니다.<br/> **Allow Users to approve or reject on Slack DM**  설정이 켜져 있으므로, DM에서 직접 사유를 입력하고 요청을 승인 또는 거절할 수 있습니다.<br/>
3. DM에서 `Details` 버튼을 클릭 시, QueryPie Admin에서 결재 요청에 대한 상세 내용을 확인하고 승인 또는 거절할 수 있습니다.<br/>
