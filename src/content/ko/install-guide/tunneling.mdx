# 🔗 Connect with Local Databases

이 가이드는 로컬에서 실행 중인 데이터베이스를 QueryPie AI 서비스에 연결하는 방법을 안내합니다. 적절한 DSN(Data Source Name) 문자열 생성과 원격 접근을 위한 보안 터널 설정 방법을 다룹니다.


## 개요

로컬 개발 환경에서 작업할 때, 로컬 머신에서 실행 중인 데이터베이스를 QueryPie AI Hub에 연결해야 하는 경우가 있습니다.

```mermaid
---
config:
  look: handDrawn
  theme: neutral
---

graph TB
    subgraph YourComputer ["💻 Your Local PC"]
        LocalDB[("Local Database<br/>(PostgreSQL, MySQL, Redis, etc.)")]
        TunnelService["Tunnel Service<br/>(ngrok etc.)"]
        LLMApp["LLM App<br/>(Cursor, Windsurf, etc.)"]
        
        LocalDB --> TunnelService
    end
    
    subgraph Internet ["🌐 Internet"]
        QueryPieAIHub["QueryPie AI Hub"]
    end
    
    TunnelService -.->|"Secure Tunnel"| QueryPieAIHub
    LLMApp -.->|"Model Context Protocol"| QueryPieAIHub
    
    %% Styles
    style YourComputer fill:#f5f5f5,stroke:#333,stroke-width:2px
    style Internet fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style LocalDB fill:#e1f5fe,stroke:#1976d2
    style TunnelService fill:#fff3e0,stroke:#f57c00
    style LLMApp fill:#f3e5f5,stroke:#7b1fa2
    style QueryPieAIHub fill:#e8f5e8,stroke:#388e3c
```
로컬 데이터베이스에 연결하려면 다음의 항목들을 준비해 주세요.

1. 로컬 데이터베이스 인스턴스 (예: PostgreSQL, MySQL, Redis 등)
2. 로컬 데이터베이스를 인터넷을 통해 접근 가능하게 만드는 터널 서비스
3. 적절한 DSN 문자열 구성


## 터널 서비스 옵션
터널 서비스로는 ngrok, Cloudflare Tunnel 등을 사용할 수 있습니다.

### ngrok

추가 기능을 제공하는 인기 있는 터널링 솔루션입니다.

```bash filename="ngrok 설치" copy
brew install ngrok
```

```bash filename="PostgreSQL 터널 생성" copy
ngrok tcp 5432
```

DSN 문자열은 다음과 같이 입력할 수 있습니다.

```bash filename="PostgreSQL DSN 예시" copy
postgresql://username:password@X.tcp.ngrok.io:XXXXX/dbname
```

### Cloudflare Tunnel

Cloudflare Tunnel은 무료이며 안정적인 터널링 서비스입니다.

```bash filename="Cloudflare Tunnel 설치" copy
brew install cloudflared
```

```bash filename="터널 생성 및 실행" copy
cloudflared tunnel --url tcp://localhost:5432
```

## 완전한 설정 예시

PostgreSQL과 ngrok을 사용한 완전한 설정 과정을 살펴보겠습니다:

### 1. 로컬 PostgreSQL 서버 시작
PostgreSQL이 기본 포트 5432에서 실행되는지 확인합니다.
```bash filename="1단계: PostgreSQL 시작" copy
brew services start postgresql
```

### 2. ngrok 터널 생성
명명된 터널을 생성합니다.
```bash filename="2단계: ngrok 터널 생성" copy
ngrok tcp 5432
```

터널이 생성되면 다음과 같은 출력을 볼 수 있습니다.

```bash filename="ngrok 출력 예시" copy
Session Status                online
Account                       your-account (Plan: Free)
Version                       3.x.x
Region                        United States (us)
Latency                       -
Web Interface                 http://127.0.0.1:4040
Forwarding                    tcp://0.tcp.ngrok.io:12345 -> localhost:5432
```

### 3. QueryPie AI에서 DSN 문자열 구성

위의 ngrok 출력에서 제공된 정보를 사용하여 DSN 문자열을 생성합니다:

```bash filename="3단계: DSN 문자열 구성" copy
postgresql://username:password@0.tcp.ngrok.io:12345/dbname
```

이 DSN 문자열을 사용하여 QueryPie AI Hub에서 데이터베이스를 추가할 수 있습니다.

## 보안 고려사항

로컬 데이터베이스를 인터넷에 노출할 때는 항상 다음 사항을 준수하세요.

- 🔒 강력한 비밀번호와 사용자명을 사용하세요. 
- 🌐 알려진 IP 범위에서만 연결을 허용하세요.
- 🔐 SSL 암호화 연결을 사용하세요. QueryPie AI Hub에서도 SSL 연결을 지원하고 있습니다.
- 📊 데이터베이스 연결 로그를 유지하고 모니터링하세요.
- ⏱️ 개발 시에는 임시 터널을 사용하신 후 즉시 종료하세요.

## 문제 해결

터널링 연결을 사용할 때 발생하는 일반적인 문제와 해결 방법을 안내합니다.

### 1. 연결 시간 초과
- 터널이 실행 중인지 확인하세요.
- 로컬 데이터베이스가 외부 연결을 허용하는지 확인하세요.
- 방화벽 규칙이 연결을 허용하는지 확인하세요.

### 2. 인증 오류
- 데이터베이스 자격 증명을 확인하세요.
- 데이터베이스 사용자가 적절한 권한을 가지고 있는지 확인하세요.
- DSN 문자열 형식이 올바른지 확인하세요.

### 3. SSL/TLS 문제
- 필요한 경우 SSL 인증서를 구성하세요.
- 보안 연결을 위해 DSN 문자열에 `sslmode=require`를 추가하세요.

### 4. 포트 충돌
- 다른 서비스가 동일한 포트를 사용하고 있는지 확인하세요.
- 필요한 경우 다른 포트로 변경하세요.

## Roadmap: Tunneling
추후 로컬 프록시에 터널링 기능이 추가될 예정입니다. (2025년 3분기 예정)<br/>
로컬 프록시에 탑재되는 터널링 기능을 통해 QueryPie AI Hub와 사용자의 네트워크가 연결될 수 있습니다.<br/>
이를 통해 다음과 같은 것들을 할 수 있습니다.
- 사용자 네트워크에서 실행중인 MCP Server를 연결하여 사용
- QueryPie를 사용중이라면 QueryPie를 통한 좀더 안전한 DB, Server, Kubernetes 접근
- QueryPie를 사용중이지 않더라도, DB, Server, Kubernetes 접근 지원

![Tunneling CLI Client](@/app/img/tunneling-drawio-1.png)


## 추가 리소스

- [ngrok 공식 문서](https://ngrok.com/docs)
- [Cloudflare Tunnel 문서](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)