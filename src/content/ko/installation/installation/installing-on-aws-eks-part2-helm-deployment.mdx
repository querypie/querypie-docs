---
title: 'AWS EKS 환경에서 설치하기 - Part 2: Helm 배포'
---

import { Callout } from 'nextra/components'

# AWS EKS 환경에서 설치하기 - Part 2: Helm 배포

Kubernetes 리소스를 생성하고 QueryPie를 Helm Chart로 배포합니다.

<Callout type="info">
이 가이드는 [AWS EKS 환경에서 설치하기](installing-on-aws-eks)의 Part 2입니다.
[Part 1: AWS 환경 설정](installing-on-aws-eks-part1-aws-setup)을 먼저 완료하세요.
</Callout>

## 1. 사전 요구사항

### 1.1 Part 1 완료 확인

```bash
# OIDC Provider 확인
aws eks describe-cluster --name <cluster-name> --region <region> \
  --query "cluster.identity.oidc.issuer" --output text

# EBS CSI Driver 확인
kubectl get pods -n kube-system | grep ebs-csi

# ALB Controller 확인
kubectl get deployment -n kube-system aws-load-balancer-controller
```

### 1.2 ACM 인증서 ARN 확인

```bash
export CERT_ARN=$(aws acm list-certificates --region <region> \
  --query "CertificateSummaryList[?DomainName=='<your-domain.example.com>'].CertificateArn" \
  --output text)

echo "Certificate ARN: $CERT_ARN"
```

## 2. Namespace 생성

```bash
kubectl create namespace querypie
```

## 3. Secret 생성

### 3.1 환경 변수 파일 작성

`querypie.env` 파일을 생성합니다:

```bash
cat > querypie.env << 'EOF'
# Agent Secret (32자 이상의 랜덤 문자열)
AGENT_SECRET=01234567890123456789012345678912

# Key Encryption Key (32자 이상의 랜덤 문자열)
KEK=01234567890123456789012345678912

# Main Database (Demo 모드: 내장 MySQL 사용)
DB_HOST=mysql
DB_PORT=3306
DB_USERNAME=querypie
DB_PASSWORD=querypie
DB_CATALOG=querypie

# Log Database
LOG_DB_HOST=mysql
LOG_DB_PORT=3306
LOG_DB_USERNAME=querypie
LOG_DB_PASSWORD=querypie
LOG_DB_CATALOG=querypie_log

# Engine/Snapshot Database
ENG_DB_HOST=mysql
ENG_DB_PORT=3306
ENG_DB_USERNAME=querypie
ENG_DB_PASSWORD=querypie
ENG_DB_CATALOG=querypie_snapshot

# Storage Database (10.2.2+)
STORAGE_DB_HOST=mysql
STORAGE_DB_PORT=3306
STORAGE_DB_CATALOG=querypie
STORAGE_DB_USER=querypie
STORAGE_DB_PASSWORD=querypie

# Redis Configuration
REDIS_CONNECTION_MODE=STANDALONE
REDIS_NODES=redis:6379
REDIS_DB=0
REDIS_PASSWORD=querypie
EOF
```

<Callout type="warning">
**보안 주의사항**

`AGENT_SECRET`, `KEK`, 데이터베이스 비밀번호는 프로덕션 환경에서 반드시 안전한 랜덤 값으로 변경하세요.
</Callout>

### 3.2 Secret 생성

```bash
kubectl create secret generic querypie-secret \
  -n querypie \
  --from-env-file=querypie.env
```

## 4. Helm Repository 추가

```bash
helm repo add querypie https://chequer-io.github.io/querypie-deployment/helm-chart
helm repo update
```

## 5. Helm Values 파일 작성

### 5.1 Demo 모드 (권장: PoC/테스트 환경)

`querypie-values.yaml` 파일을 생성합니다:

```yaml
# querypie-values.yaml (Demo Mode)

# App version - 제품 버전 문서 참조: https://docs.querypie.com/ko/installation/product-versions
appVersion: &version 11.5.1

global:
  image:
    # Docker Hub 사용 (인증 불필요)
    registry: docker.io
    tag: *version
    pullPolicy: IfNotPresent

# QueryPie 메인 애플리케이션
querypie:
  replicas: 1
  image:
    repository: querypie/querypie

  # Ingress 설정 (ALB)
  ingress:
    enabled: true
    ingressClassName: alb
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/certificate-arn: "${CERT_ARN}"
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
      alb.ingress.kubernetes.io/ssl-redirect: "443"
      alb.ingress.kubernetes.io/healthcheck-path: /api/health
    host: <your-domain.example.com>  # 실제 도메인으로 변경

  # Proxy Service (User Agent 연결용)
  proxyService:
    enabled: true
    type: LoadBalancer
    externalTrafficPolicy: "Local"

  # 리소스 설정
  # 주의: m7i.xlarge (16GB)의 allocatable memory는 약 15Gi
  # 16Gi 설정 시 Insufficient memory 에러 발생
  resources:
    requests:
      cpu: "2000m"
      memory: 8Gi
    limits:
      cpu: "2000m"
      memory: 8Gi

  # Log rotator (Docker Hub 사용 시 비활성화)
  logrotator:
    enabled: false

# QueryPie Tools (마이그레이션용)
tools:
  enabled: true
  image:
    repository: querypie/querypie-tools

# 설정
config:
  externalURL: "https://<your-domain.example.com>"  # 실제 도메인으로 변경
  secretName: "querypie-secret"

# Demo 모드: MySQL과 Redis 자동 배포
demo:
  enabled: true
  mysql:
    image: mysql:8.0
    rootPassword: "querypie"
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 2Gi
    volumeClaimTemplate:
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 50Gi
  redis:
    image: redis:7.4
    password: "querypie"
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
```

### 5.2 Production 모드 (외부 RDS/ElastiCache 사용)

외부 관리형 데이터베이스를 사용하는 경우:

```yaml
# querypie-values.yaml (Production Mode)

appVersion: &version 11.5.1

global:
  image:
    registry: docker.io
    tag: *version
    pullPolicy: IfNotPresent

querypie:
  replicas: 2  # 고가용성을 위해 2개 이상
  image:
    repository: querypie/querypie
  ingress:
    enabled: true
    ingressClassName: alb
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/certificate-arn: "${CERT_ARN}"
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
      alb.ingress.kubernetes.io/ssl-redirect: "443"
      alb.ingress.kubernetes.io/healthcheck-path: /api/health
    host: <your-domain.example.com>
  proxyService:
    enabled: true
    type: LoadBalancer
    externalTrafficPolicy: "Local"
  resources:
    requests:
      cpu: "2000m"
      memory: 16Gi
    limits:
      cpu: "2000m"
      memory: 16Gi
  logrotator:
    enabled: false

tools:
  enabled: true
  image:
    repository: querypie/querypie-tools

config:
  externalURL: "https://<your-domain.example.com>"
  secretName: "querypie-secret"  # RDS, ElastiCache 연결 정보 포함

# Demo 모드 비활성화 (외부 DB 사용)
demo:
  enabled: false
```

<Callout type="info">
Production 모드에서는 `querypie.env`의 DB/Redis 연결 정보를 RDS, ElastiCache 엔드포인트로 변경하세요.
</Callout>

## 6. Helm 설치

### 6.1 Values 파일 치환 및 설치

`${CERT_ARN}` 등 환경변수를 치환하여 설치합니다:

```bash
# CERT_ARN 환경변수가 설정되어 있는지 확인
echo "Certificate ARN: $CERT_ARN"

# envsubst로 변수 치환 후 Helm 설치
envsubst < querypie-values.yaml | helm upgrade --install querypie querypie/querypie \
  -n querypie \
  -f -
```

<Callout type="info">
**Helm Chart 버전 선택**

- QueryPie ACP 11.3.0 이상: Helm Chart 1.5.0 이상 사용
- QueryPie ACP 11.3.0 이전: Helm Chart 1.4.4 사용

특정 버전 지정:
```bash
helm upgrade --install querypie querypie/querypie --version 1.5.0 -n querypie -f -
```
</Callout>

### 6.2 설치 확인

```bash
# Pod 상태 확인
kubectl get pods -n querypie -w

# 서비스 확인
kubectl get svc -n querypie

# Ingress 확인
kubectl get ingress -n querypie
```

예상 출력:
```
NAME                        READY   STATUS    RESTARTS   AGE
querypie-querypie-0         1/1     Running   0          5m
querypie-querypie-mysql-0   1/1     Running   0          5m
querypie-querypie-redis-0   1/1     Running   0          5m
querypie-querypie-tools-xxx 1/1     Running   0          5m
```

## 7. 데이터베이스 마이그레이션

<Callout type="error">
**필수 단계**

이 단계를 건너뛰면 `Table 'querypie.system_settings' doesn't exist` 오류가 발생하며 QueryPie가 정상 작동하지 않습니다.
</Callout>

### 7.1 MySQL 준비 대기

```bash
kubectl wait --for=condition=ready pod/querypie-querypie-mysql-0 -n querypie --timeout=300s
```

### 7.2 마이그레이션 실행

```bash
kubectl exec -it deployment/querypie-querypie-tools -n querypie -- /app/script/migrate.sh runall
```

### 7.3 QueryPie Pod 재시작

마이그레이션 완료 후 QueryPie Pod를 재시작합니다:

```bash
kubectl delete pod querypie-querypie-0 -n querypie
```

> Pod는 StatefulSet에 의해 자동으로 재생성됩니다.

## 8. Route53 DNS 설정

### 8.1 ALB DNS 이름 확인

```bash
# ALB 프로비저닝 대기 (2-3분 소요)
kubectl get ingress -n querypie -w

# ALB DNS 이름 조회
ALB_DNS=$(kubectl get ingress -n querypie -o jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}')
echo "ALB DNS: $ALB_DNS"
```

### 8.2 Route53 A 레코드 생성

AWS Console에서 Route53 Hosted Zone에 A 레코드(Alias)를 생성하거나, CLI를 사용합니다:

```bash
# Hosted Zone ID 조회 (example.com 부분을 실제 도메인으로 변경)
HOSTED_ZONE_ID=$(aws route53 list-hosted-zones \
  --query "HostedZones[?Name=='example.com.'].Id" --output text | cut -d'/' -f3)

# ALB Hosted Zone ID (ap-northeast-2 리전)
# 다른 리전은 AWS 문서 참조: https://docs.aws.amazon.com/general/latest/gr/elb.html
ALB_ZONE_ID="ZWKZPGTI48KDX"

# A 레코드 생성
aws route53 change-resource-record-sets \
  --hosted-zone-id $HOSTED_ZONE_ID \
  --change-batch '{
    "Changes": [{
      "Action": "UPSERT",
      "ResourceRecordSet": {
        "Name": "<your-domain.example.com>",
        "Type": "A",
        "AliasTarget": {
          "HostedZoneId": "'$ALB_ZONE_ID'",
          "DNSName": "'$ALB_DNS'",
          "EvaluateTargetHealth": true
        }
      }
    }]
  }'
```

## 9. 접속 확인

### 9.1 DNS 전파 확인

```bash
dig <your-domain.example.com>
```

### 9.2 HTTPS 접속 테스트

```bash
curl -I https://<your-domain.example.com>
```

예상 응답:
```
HTTP/2 200
```

### 9.3 브라우저 접속

`https://<your-domain.example.com>` 으로 접속하여 QueryPie 로그인 화면이 표시되는지 확인합니다.

## 10. 설치 후 설정

### 10.1 라이선스 활성화

웹 콘솔에 처음 접속하면 라이선스 입력 화면이 표시됩니다.
PEM 형식의 라이선스를 입력하여 활성화합니다.

자세한 내용은 [라이선스 설치](../license-installation) 문서를 참조하세요.

### 10.2 기본 설정

라이선스 활성화 후 다음 설정을 진행합니다:

* **QueryPie Web Base URL 설정**: Admin Page → General
* **Proxy 주소 설정**: DAC/SAC, KAC, WAC 기능별 설정

자세한 설정 절차는 [설치 가이드 - setup.v2.sh](installation-guide-setupv2sh#기본-설정-절차) 문서를 참조하세요.

## 11. 트러블슈팅

### 11.1 Pod 관련

| 증상 | 원인 | 해결책 |
|------|------|--------|
| `Insufficient memory` | 메모리 요청 > 노드 allocatable | 메모리를 8Gi로 조정 또는 더 큰 노드 사용 |
| `ImagePullBackOff` | 이미지 다운로드 실패 | `docker.io` 접근 가능 여부 확인 |
| `CrashLoopBackOff` | 애플리케이션 오류 | 로그 확인: `kubectl logs -n querypie querypie-querypie-0` |

### 11.2 데이터베이스 관련

| 증상 | 원인 | 해결책 |
|------|------|--------|
| `Table 'querypie.system_settings' doesn't exist` | 마이그레이션 미실행 | 섹션 7 마이그레이션 실행 |
| MySQL 연결 실패 | Demo 모드 MySQL 미시작 | MySQL Pod 상태 확인 |

```bash
# MySQL 연결 테스트
kubectl exec -it querypie-querypie-mysql-0 -n querypie -- \
  mysql -uroot -pquerypie -e "SHOW DATABASES;"
```

### 11.3 Ingress/ALB 관련

| 증상 | 원인 | 해결책 |
|------|------|--------|
| ALB 미생성 | ALB Controller 미설치 | Part 1 섹션 4 확인 |
| 인증서 오류 | ACM ARN 불일치 | `CERT_ARN` 환경변수 확인 |
| 502 Bad Gateway | 타겟 그룹 헬스체크 실패 | Pod 상태 및 포트 확인 |

```bash
# Ingress 이벤트 확인
kubectl describe ingress -n querypie

# ALB Controller 로그 확인
kubectl logs -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller
```

## 12. 정리 (삭제)

```bash
# QueryPie 삭제 (Demo MySQL/Redis 포함)
helm uninstall querypie -n querypie

# Secret 삭제
kubectl delete secret querypie-secret -n querypie

# Namespace 삭제
kubectl delete namespace querypie

# Route53 레코드 삭제 (AWS Console에서 수동 삭제 권장)
```

## 13. 참고 자료

* [QueryPie Helm Chart GitHub](https://github.com/chequer-io/querypie-deployment)
* [제품 버전](../product-versions)
* [컨테이너 환경변수](../container-environment-variables)
* [라이선스 설치](../license-installation)
