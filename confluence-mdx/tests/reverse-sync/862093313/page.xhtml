<p /><ac:structured-macro ac:name="toc" ac:schema-version="1" data-layout="default" ac:local-id="62327b93-d269-4401-b66c-a33060d8bfb5" ac:macro-id="e786e4ee-2f0e-4a56-be46-56956f9022e3"><ac:parameter ac:name="minLevel">1</ac:parameter><ac:parameter ac:name="maxLevel">6</ac:parameter><ac:parameter ac:name="outline">false</ac:parameter><ac:parameter ac:name="style">none</ac:parameter><ac:parameter ac:name="type">list</ac:parameter><ac:parameter ac:name="printable">true</ac:parameter></ac:structured-macro><h2>시스템 아키텍처</h2><p>QueryPie Server, QueryPie User Agent, User PC 의 Web Browser, 그리고 이용자의 접근 대상인 Database, Linux Server 등의 시스템이 어떻게 구성되고 연결되는지 알아봅니다. </p><h3>시스템 아키텍처 구성도</h3><p>이 시스템 아키텍처는 단일 리눅스 서버에 QueryPie Service 를 설치하는 경우의 아키텍처입니다. TLS 인증서를 적용한 웹서비스, 고가용성을 위한 다중화 구성 등을 포함하지 않습니다.</p><ac:image ac:align="center" ac:layout="center" ac:original-height="843" ac:original-width="1600" ac:custom-width="true" ac:alt="image-20251204-043839.png" ac:width="904"><ri:attachment ri:filename="image-20251204-043839.png" ri:version-at-save="1" /><ac:caption><p>Overview of QueryPie System Architecture </p></ac:caption></ac:image><p /><p>각 컴포넌트에 대한 설명은 다음과 같습니다.</p><h3>User PC 의 Web Browser</h3><p>이용자의 PC 에서 웹 브라우저를 통해 QueryPie 웹 서비스에 접속합니다. QueryPie 를 이용하기 위해서는 웹 브라우저가 필수적입니다. QueryPie 관리자, 보안정책 운영자는 QueryPie Web Console 을 통해 QueryPie 서비스를 관리합니다.</p><p>또한, QueryPie 사용자는 QueryPie Web SQL Editor, Web Terminal 을 통해 대상 시스템에 접근할 수 있습니다.</p><h3>User PC 의 QueryPie User Agent</h3><p>User PC 에서 작동하는 Database Client Application, SSH Client Application 를 이용하는 경우, QueryPie User Agent 가 필요합니다. QueryPie User Agent 는 User PC 에서 작동하는 Local Proxy Agent 의 역할을 수행합니다. QueryPie Web Console 에 로그인하면, QueryPie User Agent 를 다운로드 받을 수 있습니다.</p><p>QueryPie User Agent 는 User PC 에서 작동하는 대부분의 Database Client Application, SSH Client Application 을 지원합니다. (이후 <code>3rd Party Tool</code> 이라고 표기합니다.) 구체적인 사례는 이 문서를 참조하세요: <ac:link ac:card-appearance="inline"><ri:page ri:space-key="QCP" ri:content-title="Supported 3rd Party Tools (KO)" ri:version-at-save="28" /><ac:link-body>Supported 3rd Party Tools (KO)</ac:link-body></ac:link></p><h3>QueryPie Server</h3><p>Linux VM 에서 작동하는 QueryPie Server 는 Web Console, Web SQL Editor, Web Terminal 을 웹서비스로 제공합니다. 또한 SQL protocol, ssh protocol 을 이해하고 접근제어 수행하는 Proxy server 을 제공하는 핵심적 역할을 수행합니다.</p><p>QueryPie Server 는 두 가지 컴포넌트를 필요로 합니다.</p><ul><li><p>QueryPie Database</p></li><li><p>QueryPie Redis</p></li></ul><h3>QueryPie Database</h3><p>QueryPie Database 는 QueryPie Server 의 작동을 위한 데이터를 저장합니다. QueryPie 의 User Account, Admin Account, 연결 대상 시스템의 정보, 접근제어 정책 등을 저장합니다. 뿐만 아니라, User 의 Query Log, System Access Log 등 Audit 정보를 저장합니다.</p><p>MySQL, MariaDB 또는 호환되는 Database 를 QueryPie Database 로 사용할 수 있습니다.</p><ul><li><p>AWS Aurora MySQL</p></li><li><p>GCP Cloud SQL for MySQL</p></li></ul><h3>QueryPie Redis</h3><p>QueryPie Redis 는 QueryPie Server 의 작동을 위한 Cache 역할을 수행합니다. QueryPie Server 가 작동하기 위해, 필수로 요구되는 컴포넌트입니다.</p><h3>Target Database</h3><p>이용자가 접근을 원하는 Database 서버입니다. QueryPie Server 는 이용자와 Target Database 사이의 중계 역할을 수행합니다.</p><h3>Target Server System</h3><p>이용자가 접근을 원하는 Linux Server, Windows Server 등의 시스템입니다. QueryPie Server 는 이용자와 Target Server System 사이의 중계 역할을 수행합니다.</p><p /><h2>네트워크 접근제어 설정</h2><h3>네트워크 접근 유형</h3><p>QueryPie 가 설치된 Linux VM 을 중심으로, 네트워크 연결을 Outbound, Inbound, 두 가지 유형으로 구분합니다.</p><ul><li><p>Outbound : QueryPie 가 설치된 Linux VM 에서, 외부 인터넷으로 연결하는 네트워크 접근입니다.</p></li><li><p>Inbound : 이용자의 PC 또는 고객사 내부 네트워크에서, QueryPie 가 설치된 Linux VM 으로 연결하는 네트워크 접근입니다.</p></li></ul><h3>소프트웨어 설치를 위한 네트워크 접근</h3><table data-table-width="1159" data-layout="align-start" ac:local-id="be13189e-5027-4662-8dce-2e181d376dc9"><colgroup><col style="width: 126.0px;" /><col style="width: 184.0px;" /><col style="width: 272.0px;" /><col style="width: 120.0px;" /><col style="width: 105.0px;" /><col style="width: 351.0px;" /></colgroup><tbody><tr><td data-highlight-colour="#efefef"><p><strong>Access Type</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Source</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Destination</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Protocol</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Port&nbsp;</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Description</strong></p></td></tr><tr><td><p>Outbound</p></td><td><p>QueryPie Server</p></td><td><p>FQDN: <code>dl.querypie.com</code><br />IPv4 Address: <br /><code>18.67.51.51</code>,<br /><code>18.67.51.67</code>,<br /><code>18.67.51.73</code>,<br /><code>18.67.51.76</code></p></td><td><p>TCP</p></td><td><p>443</p></td><td><p>제품 설치를 위한 설정파일을 내려받는 website 입니다.</p></td></tr><tr><td><p>Outbound</p></td><td><p>QueryPie Server</p></td><td><p>FQDN: <code>harbor.querypie.io</code><br />IPv4 Address:<br /><code>15.164.47.8</code>, <code>52.79.197.102</code></p></td><td><p>TCP</p></td><td><p>443</p></td><td><p>제품 설치를 위해, Docker Image 를 내려받는 website 입니다. docker 용어로는 Docker Registry 입니다.</p></td></tr></tbody></table><h3>제품 사용을 위한 네트워크 접근</h3><p>아래의 항목은 제품 사용을 위한 네트워크 접근을 설명합니다. QueryPie 제품의 기능에 따라, 공통, DAC, SAC, KAC, WAC 로 구분합니다.</p><h3>공통</h3><table data-table-width="1157" data-layout="align-start" ac:local-id="36e3a71a-b84c-4b61-93c9-5814d8141c3b"><colgroup><col style="width: 117.0px;" /><col style="width: 199.0px;" /><col style="width: 211.0px;" /><col style="width: 102.0px;" /><col style="width: 97.0px;" /><col style="width: 90.0px;" /><col style="width: 340.0px;" /></colgroup><tbody><tr><td data-highlight-colour="#efefef"><p><strong>Access Type</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Source</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Destination</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Service</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Protocol</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Port</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Description</strong></p></td></tr><tr><td><p>Inbound</p></td><td><p>PC of Admin User</p></td><td><p>QueryPie Server</p></td><td><p>SSH</p></td><td><p>TCP</p></td><td><p>22</p></td><td><p>Installation and management</p></td></tr><tr><td><p>Inbound</p></td><td><p>PC of Admin User</p></td><td><p>QueryPie Server</p></td><td><p>HTTP</p></td><td><p>TCP</p></td><td><p>80</p></td><td><p>QueryPie Web Console</p></td></tr><tr><td><p>Inbound</p></td><td><p>PC of Admin User</p></td><td><p>QueryPie Server</p></td><td><p>HTTPS</p></td><td><p>TCP</p></td><td><p>443</p></td><td><p>QueryPie Web Console</p></td></tr><tr><td><p>Inbound</p></td><td><p>PC of Admin User</p></td><td><p>QueryPie Server</p></td><td><p>Custom TCP</p></td><td><p>TCP</p></td><td><p>9000</p></td><td><p>QueryPie Proxy for User Agent</p></td></tr><tr><td><p>Inbound</p></td><td><p>PC of Admin User</p></td><td><p>QueryPie Server</p></td><td><p>MySQL</p></td><td><p>TCP</p></td><td><p>3306</p></td><td><p>(Optional) QueryPie Meta DB</p></td></tr><tr><td><p>Inbound</p></td><td><p>PC of Admin User</p></td><td><p>QueryPie Server</p></td><td><p>Redis</p></td><td><p>TCP</p></td><td><p>6379</p></td><td><p>(Optional) QueryPie CacheDB</p></td></tr><tr><td><p>Inbound</p></td><td><p>All the users<br /></p></td><td><p>QueryPie Server<br />or<br />Application Load Balancer</p></td><td><p>HTTP</p></td><td><p>TCP</p></td><td><p>80</p></td><td><p>QueryPie Web Console</p></td></tr><tr><td><p>Inbound</p></td><td><p>All the users<br /></p></td><td><p>QueryPie Server<br />or<br />Application Load Balancer</p></td><td><p>HTTPS</p></td><td><p>TCP</p></td><td><p>443</p></td><td><p>(<strong>Recommended</strong>) QueryPie Web Console</p></td></tr><tr><td><p>Inbound</p></td><td><p>All the users<br /></p></td><td><p>QueryPie Server<br />or<br />Network Load Balancer</p></td><td><p>Custom TCP</p></td><td><p>TCP</p></td><td><p>9000</p></td><td><p>(<strong>Recommended</strong>) QueryPie Proxy for User Agent</p></td></tr></tbody></table><h3>DAC</h3><table data-table-width="1159" data-layout="align-start" ac:local-id="45cc8d56-e03b-483f-b4d9-49b0823db32c"><colgroup><col style="width: 126.0px;" /><col style="width: 220.0px;" /><col style="width: 157.0px;" /><col style="width: 112.0px;" /><col style="width: 97.0px;" /><col style="width: 101.0px;" /><col style="width: 335.0px;" /></colgroup><tbody><tr><td data-highlight-colour="#efefef"><p><strong>Access Type</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Source</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Destination</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Type</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Protocol</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Port Range</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Description</strong></p></td></tr><tr><td><p>Inbound</p></td><td><p>Users or Systems connecting to Agentless Proxy</p></td><td><p>QueryPie Server</p></td><td><p>Custom TCP</p></td><td><p>TCP</p></td><td><p>40000 - 41000</p></td><td><p>(<strong>Recommended</strong>) QueryPie Agentless Proxy</p></td></tr><tr><td><p>Inbound</p></td><td><p>Users or Systems connecting to Agentless Proxy</p></td><td><p>QueryPie Server</p></td><td><p>Custom TCP</p></td><td><p>TCP</p></td><td><p>41001 - 45000</p></td><td><p>(Optional) More ports for QueryPie Agentless Proxy</p></td></tr></tbody></table><h3>SAC</h3><table data-table-width="1160" data-layout="align-start" ac:local-id="098a2aff-99a3-4f48-9815-d9d8bdc8fe82"><colgroup><col style="width: 121.0px;" /><col style="width: 164.0px;" /><col style="width: 199.0px;" /><col style="width: 120.0px;" /><col style="width: 103.0px;" /><col style="width: 103.0px;" /><col style="width: 334.0px;" /></colgroup><tbody><tr><td data-highlight-colour="#efefef"><p><strong>Access Type</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Source</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Destination</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Type</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Protocol</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Port</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Description</strong></p></td></tr><tr><td><p>Outbound</p></td><td><p>QueryPie Server</p></td><td><p>Target Linux Servers</p></td><td><p>SSH</p></td><td><p>TCP</p></td><td><p>22</p></td><td><p>When Users access target linux machines via QueryPie</p></td></tr><tr><td><p>Outbound</p></td><td><p>QueryPie Server</p></td><td><p>Target Windows Servers</p></td><td><p>RDP</p></td><td><p>TCP</p></td><td><p>3389</p></td><td><p>When Admin installs QueryPie RDP Agent on target Windows Servers.&nbsp;</p></td></tr><tr><td><p>Outbound</p></td><td><p>QueryPie Server</p></td><td><p>Target Windows Servers</p></td><td><p>Custom RDP</p></td><td><p>TCP</p></td><td><p>13389</p></td><td><p>When Users access target Windows Servers via QueryPie</p></td></tr><tr><td><p>Outbound</p></td><td><p>QueryPie Server</p></td><td><p>Target Windows Servers</p></td><td><p>Custom TCP</p></td><td><p>TCP</p></td><td><p>13390</p></td><td><p>Obsoleted - Port 13390 is not used anymore since version 10.2.2</p></td></tr></tbody></table><h3>KAC</h3><table data-table-width="1160" data-layout="align-start" ac:local-id="b6128db4-38c8-4b5d-b0cd-4ff083e10bc6"><colgroup><col style="width: 119.0px;" /><col style="width: 178.0px;" /><col style="width: 191.0px;" /><col style="width: 126.0px;" /><col style="width: 112.0px;" /><col style="width: 111.0px;" /><col style="width: 317.0px;" /></colgroup><tbody><tr><td data-highlight-colour="#efefef"><p><strong>Access Type</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Source</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Destination</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Type</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Protocol</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Port</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Description</strong></p></td></tr><tr><td><p>Inbound</p></td><td><p>All the users</p></td><td><p>QueryPie Server<br />or<br />Network Load Balancer</p></td><td><p>Custom TCP</p></td><td><p>TCP</p></td><td><p>6443</p></td><td><p>From Users to QueryPie KAC Proxy</p></td></tr><tr><td><p>Outbound</p></td><td><p>QueryPie Server</p></td><td><p>Target Kubernetes Cluster</p></td><td><p>Custom TCP</p></td><td><p>TCP</p></td><td><p>6443</p></td><td><p>From QueryPie Server to target Kubernetes Clusters</p></td></tr></tbody></table><h3>WAC</h3><table data-table-width="1160" data-layout="align-start" ac:local-id="71e0c737-d039-4f9a-a55a-b3589ee4e8ca"><colgroup><col style="width: 122.0px;" /><col style="width: 171.0px;" /><col style="width: 197.0px;" /><col style="width: 124.0px;" /><col style="width: 112.0px;" /><col style="width: 111.0px;" /><col style="width: 316.0px;" /></colgroup><tbody><tr><td data-highlight-colour="#efefef"><p><strong>Access Ty</strong>pe</p></td><td data-highlight-colour="#efefef"><p><strong>Source</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Destination</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Type</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Protocol</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Port</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Description</strong></p></td></tr><tr><td><p>Inbound</p></td><td><p>All the users<br /></p></td><td><p>QueryPie Server<br />or<br />Network Load Balancer</p></td><td><p>Custom TCP</p></td><td><p>TCP</p></td><td><p>7447</p></td><td><p>From Users to QueryPie WAC Proxy</p></td></tr></tbody></table><h2>Load Balancers 설정</h2><p>부하분산, 장애내성을 갖추기 위해, QueryPie Service 에 Load Balancer 를 적용하는 설정을 표로 설명합니다.</p><table data-table-width="1161" data-layout="align-start" ac:local-id="8ff8ba2a-966e-4f45-85e2-4d178f45ad95"><colgroup><col style="width: 211.0px;" /><col style="width: 129.0px;" /><col style="width: 164.0px;" /><col style="width: 214.0px;" /><col style="width: 153.0px;" /><col style="width: 259.0px;" /></colgroup><tbody><tr><td data-highlight-colour="#efefef"><p><strong>LB</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Listener</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Target</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Health Check</strong></p></td><td data-highlight-colour="#efefef"><p><strong>LB Option</strong></p></td><td data-highlight-colour="#efefef"><p><strong>Description</strong></p></td></tr><tr><td rowspan="2"><p>Application Load Balancer<br />(L7)</p></td><td><p>HTTP / 80</p></td><td><p>-</p></td><td><p>None</p></td><td><p>default</p></td><td><p>Redirection to HTTPS</p></td></tr><tr><td><p>HTTPS / 443</p></td><td><p>http://querypie:80</p></td><td><p>http://querypie:80/readyz</p></td><td><p>Sticky Session</p></td><td><p>QueryPie Web Console</p></td></tr><tr><td rowspan="3"><p>Network Load Balancer<br />(L4)&nbsp;</p></td><td><p>TCP / 9000</p></td><td><p>querypie:9000</p></td><td><p>http://querypie:80/readyz</p></td><td><p>default</p></td><td><p>QueryPie Agent (DAC, SAC)</p></td></tr><tr><td><p>TCP / 6443</p></td><td><p>querypie:6443</p></td><td><p>http://querypie:80/readyz</p></td><td><p>default</p></td><td><p>QueryPie Agent (KAC)</p></td></tr><tr><td><p>TCP / 7447</p></td><td><p>querypie:7447</p></td><td><p>http://querypie:80/readyz</p></td><td><p>default</p></td><td><p>QueryPie Agent (WAC)</p></td></tr></tbody></table><p>&nbsp;</p>